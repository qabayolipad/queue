<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Queue System</title>
<style>
  body { background: beige; font-family: Arial, sans-serif; color: #333; }
  .container { max-width: 500px; margin: 40px auto; }
  .welcome { background: #dcd6b8; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
  form { display: flex; flex-direction: column; gap: 15px; background: #f4f1de; padding: 20px; border-radius: 8px; }
  input, select, button { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
  button { background: #b58900; color: white; cursor: pointer; font-weight: bold; }
  button.logout { margin-top: 15px; background: #006400; }
  p.instructions { margin-top: 0; font-size: 0.9rem; color: #555; }
</style>
</head>
<body>

<div class="container">
  <div class="welcome"></div>

  <form id="queueForm">
    <p class="instructions">Fill out the form to join the queue for your selected service.</p>

    <input type="text" name="name" placeholder="Your Name" required />
    <select name="role" required>
      <option value="" disabled selected>Select Role</option>
      <option value="Student">Student</option>
      <option value="Staff">Staff</option>
      <option value="Professor">Professor</option>
    </select>
    <select name="service" required>
      <option value="" disabled selected>Select Service</option>
      <option value="Registrar">Registrar</option>
      <option value="Clinic">Clinic</option>
      <option value="Guidance">Guidance</option>
    </select>
    <input type="text" name="purpose" placeholder="Purpose" required />
    <button type="submit">Join Queue</button>
  </form>

  <button class="logout">Logout</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
<script>
  const supabaseUrl = 'https://kkvlvhgwnurqffizviss.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtrdmx2aGd3bnVycWZmaXp2aXNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NDg5NzYsImV4cCI6MjA2MzUyNDk3Nn0.COFES5GgdsFDB7nhUyf_bK9sC55-lMyYb7YL8NTvkfE'; // Put your anon key here
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // Check user session and show form or redirect
  async function checkSession() {
    const { data, error } = await supabase.auth.getSession();
    if (error) {
      alert('Error checking session: ' + error.message);
      return;
    }
    if (!data.session) {
      // Not logged in -> redirect to login page
      window.location.href = 'login.html';
    } else {
      document.querySelector('.welcome').innerHTML =
        `<h2>Welcome, ${data.session.user.email}</h2>
         <p>Fill out the form below to join the queue.</p>`;
      document.getElementById('queueForm').style.display = 'flex';
    }
  }
  checkSession();

  // Submit queue form
  document.getElementById('queueForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = e.target.name.value.trim();
    const role = e.target.role.value;
    const service = e.target.service.value;
    const purpose = e.target.purpose.value.trim();

    if (!name || !role || !service || !purpose) {
      alert('Please fill all fields');
      return;
    }

    const { error } = await supabase.from('queue').insert([{ name, role, service, purpose }]);

    if (error) {
      alert('Failed to join queue: ' + error.message);
    } else {
      alert('You have been added to the queue!');
      e.target.reset();
    }
  });

  // Logout
  document.querySelector('.logout').addEventListener('click', async () => {
    const { error } = await supabase.auth.signOut();
    if (error) {
      alert('Logout failed: ' + error.message);
    } else {
      window.location.href = 'login.html';
    }
  });
</script>

</body>
</html>
